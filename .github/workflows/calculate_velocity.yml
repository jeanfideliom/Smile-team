name: Sprint Velocity Calculation

on:
  workflow_dispatch:  # Allows manual execution
  schedule:
    - cron: "0 0 * * 0"  # Runs every Sunday at midnight (GitHub uses 0 for Sunday)

jobs:
  calculate-velocity:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Fetch Completed Issues
        id: fetch_issues
        uses: octokit/request-action@v2.x
        with:
          route: GET /repos/{owner}/{repo}/issues?state=closed
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Calculate Velocity
        run: |
          import json
          import os

          issues = json.loads(os.environ['ISSUES'])
          velocity = sum(
              int(issue['labels'][0]['name'].split(':')[-1]) for issue in issues if issue['labels']
          )

          print(f"ðŸ”¥ Sprint Velocity: {velocity} Story Points")

          with open("velocity.txt", "w") as f:
              f.write(f"Sprint Velocity: {velocity} Story Points\n")

      - name: Upload Velocity Report
        uses: actions/upload-artifact@v3
        with:
          name: velocity-report
          path: velocity.txt
