name: Sprint Velocity Calculation

on:
  workflow_dispatch:  # Allows manual execution
  schedule:
    - cron: "0 0 * * 0"  # Runs every Sunday at midnight

permissions:
  issues: read  # Ensure API can read issues

jobs:
  calculate-velocity:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Fetch Completed Issues
        id: fetch_issues
        uses: octokit/request-action@v2.x
        with:
          route: GET /repos/${{ github.repository }}/issues?state=closed
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Store API Response
        run: echo '${{ steps.fetch_issues.outputs.data }}' > issues.json

      - name: Create Velocity Calculation Script
        run: |
          cat <<EOF > calculate_velocity.py
          import json

          try:
              # Load issues JSON
              with open("issues.json", "r") as f:
                  data = f.read()
                  if not data.strip():
                      raise ValueError("API response is empty")
                  issues = json.loads(data)

              # Calculate velocity (sum of Story Points from labels)
              velocity = sum(
                  int(label['name'].split(':')[-1]) for issue in issues if 'labels' in issue 
                  for label in issue['labels'] if label['name'].startswith("SP:")
              )

              print(f"üî• Sprint Velocity: {velocity} Story Points")

              with open("velocity.txt", "w") as f:
                  f.write(f"Sprint Velocity: {velocity} Story Points\n")

          except Exception as e:
              print(f"‚ùå Error: {e}")
              exit(1)
          EOF

      - name: Run Velocity Calculation
        run: python3 calculate_velocity.py

      - name: Upload Velocity Report
        uses: actions/upload-artifact@v4
        with:
          name: velocity-report
          path: velocity.txt
